(("undefined"!==typeof self?self:this)["webpackChunkvcd_node_driver_0_5_0"]=("undefined"!==typeof self?self:this)["webpackChunkvcd_node_driver_0_5_0"]||[]).push([[916],{5403:function(e,t,a){"use strict";a.r(t);var r=a(429),s=a.n(r),o=a(1214),i=a.n(o),n=i()(s());n.push([e.id,".allow-list-error[data-v-026c1912]{display:flex}.allow-list-error[data-v-026c1912]>:first-child{flex:1}",""]),t["default"]=n},3e3:function(e,t,a){"use strict";a.r(t);var r=a(429),s=a.n(r),o=a(1214),i=a.n(o),n=i()(s());n.push([e.id,".icon-spacer[data-v-58c7118c]{width:24px}",""]),t["default"]=n},9382:function(e,t,a){"use strict";a.d(t,{k:function(){return l}});var r=a(667),s=a(4364);function o(e,t,a){return(t=i(t))in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e){var t=n(e,"string");return"symbol"==typeof t?t:t+""}function n(e,t){if("object"!=typeof e||!e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var r=a.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}class l{constructor(e,t){o(this,"href",""),o(this,"username",""),o(this,"password",""),o(this,"org",""),o(this,"orgId",""),o(this,"version","36.0"),o(this,"vdc",""),o(this,"vappName",""),o(this,"token",""),o(this,"$dispatch",void 0),t.annotations?Object.keys(t.annotations).forEach((e=>{const a=e.split("/");if(2===a.length&&"vcd.cattle.io"===a[0]){const r=a[1];this[r]=t.annotations[e]}})):Object.keys(t).forEach((e=>{this[e]=t[e]})),this.$dispatch=e.dispatch}protocolHostname(e){const t=(0,r.qg)(e);return t?.host||""}getDeepKey(e,t){return t.replace(/\[([^\[\]]*)\]/g,".$1.").split(".").filter((e=>""!==e)).reduce(((e,t)=>e&&e[t]),e)}async getToken(){const e=`/meta/proxy/${this.protocolHostname(this.href)}/cloudapi/1.0.0/sessions`,t={Accept:`application/*;version=${this.version}`,"X-API-Auth-Header":`Basic ${btoa(`${this.username}@${this.org}:${this.password}`)}`};try{const a=await this.$dispatch("management/request",{url:e,headers:t,method:"POST",redirectUnauthorized:!1},{root:!0});if(502===a._status)return{error:"Could not proxy request - URL may not be in Rancher's allow list"};const r=a._headers["x-vmware-vcloud-access-token"];return this.token=r,this.orgId=a.org.id.replace(/^urn:vcloud:org:/,""),a}catch(a){return s.error(a),{error:a}}}async getCatalog(e,t){return await this.getOptions(e,"/query?type=catalog&pageSize=1000","record",void 0,t)}async getTemplate(e,t,a){return await this.getOptions(e,`/query?type=vAppTemplate&pageSize=1000&filter=(catalogName==${t})`,"record",void 0,a)}async getNetwork(e,t){return await this.getOptions(e,"/cloudapi/1.0.0/orgVdcNetworks?filterEncoded=true&pageSize=20&filter=((crossVdcNetworkId==null))","values",void 0,t,!0)}async getStorage(e,t){return await this.getOptions(e,"/query?type=orgVdcStorageProfile&pageSize=1000","record",(e=>{if(e.vdcName===this.vdc)return e}),t)}async getVAppVms(e,t,a){return await this.getOptions(e,(0,r.qg)(t).path.replace(/^\/api/,""),"children.vm",(e=>{const t=e.section.find((e=>"VmSpecSectionType"===e._type));return{...e,osType:t.osType,hardwareVersionHref:t.hardwareVersion.href}}),a)}async getOperatingSystem(e,t,a){return await this.getOptions(e,(0,r.qg)(t).path.replace(/^\/api/,""),"supportedOperatingSystems.operatingSystemFamilyInfo[1].operatingSystem",(e=>({...e,name:e.internalName})),a)}setOptions(e,t,a,r,s){if(e){let o=this.getDeepKey(e,a)||[];if(r&&(o=o.map((e=>r(e)))),t.options=this.convertToOptions(o),t.busy=!1,s){const e=t.options.find((e=>e.value.name===s));e&&(t.selected=e.value)}!t.selected&&t.options.length>0&&(t.selected=t.options[0].value)}else t.options=[],t.selected=null,t.busy=!1,t.enabled=!1}async getOptions(e,t,a,r,s,o){e.busy=!0,e.enabled=!0,e.selected="";let i=!0,n=await this.makeComputeRequest(t,o);const l=n;let d=1;if(n?.pageCount)while(i)n?.pageCount>n?.page?(d=n.page+1,n=await this.makeComputeRequest(`${t}&page=${d}`,o),l[a]=l[a].concat(n[a])):i=!1;this.setOptions(l,e,a,r,s)}async makeComputeRequest(e,t){const a=t?(0,r.qg)(this.href).host:this.href.replace(/^https?:\/\//,""),o=`/meta/proxy/${a}`,i=`${o}${e}`,n=t?{Accept:`application/json;multisite=global;version=${this.version}`,"X-API-Auth-Header":`Bearer ${this.token}`}:{Accept:`application/*+json;version=${this.version}`,"X-API-Auth-Header":`Bearer ${this.token}`};try{const e=await this.$dispatch("management/request",{url:i,headers:n,method:"GET",redirectUnauthorized:!1},{root:!0});return e}catch(l){s.error(l)}}async getVdcs(){const e=this.href.replace(/^https?:\/\//,""),t=`/meta/proxy/${e}`,a={Accept:`application/*+json;version=${this.version}`,"X-API-Auth-Header":`Bearer ${this.token}`};try{const e=await this.$dispatch("management/request",{url:`${t}/org/${this.orgId}/vdcRollup`,headers:a,method:"GET",redirectUnauthorized:!1},{root:!0});return e?.orgVdcReference}catch(r){return s.error(r),{error:r}}}async getVApps(){const e=this.href.replace(/^https?:\/\//,""),t=`/meta/proxy/${e}`,a={Accept:`application/*+json;version=${this.version}`,"X-API-Auth-Header":`Bearer ${this.token}`};try{const e=await this.$dispatch("management/request",{url:`${t}/query?type=vApp&pageSize=1000`,headers:a,method:"GET",redirectUnauthorized:!1},{root:!0});return e?.record}catch(r){return s.error(r),{error:r}}}convertToOptions(e){let t=(e||[]).sort(((e,t)=>e.name.localeCompare(t.name)));return t=t.filter((e=>void 0!==e)),t.map((e=>({label:e.name,value:e})))}}},3393:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return I}});var r=a(9274);const s={class:"row"},o={class:"col span-6"},i={class:"col span-6"},n={class:"row"},l={class:"col span-6"},d={class:"col span-6"},c=["disabled"],u=["disabled"],p={key:2,class:"row mt-20"},h={class:"col span-6"},v={class:"col span-6"};function m(e,t,a,m,y,f){const g=(0,r.resolveComponent)("LabeledInput"),b=(0,r.resolveComponent)("BusyButton"),w=(0,r.resolveComponent)("Banner"),k=(0,r.resolveComponent)("LabeledSelect");return(0,r.openBlock)(),(0,r.createElementBlock)("div",null,[(0,r.createElementVNode)("div",s,[(0,r.createElementVNode)("div",o,[(0,r.createVNode)(g,{value:a.value.decodedData.href,disabled:1!==y.step,"label-key":"driver.vcd.auth.fields.href","placeholder-key":"driver.vcd.auth.placeholders.href",type:"text",mode:a.mode,"onUpdate:value":t[0]||(t[0]=e=>{a.value.setData("href",e)})},null,8,["value","disabled","mode"])]),(0,r.createElementVNode)("div",i,[(0,r.createVNode)(g,{value:a.value.decodedData.org,disabled:1!==y.step,"label-key":"driver.vcd.auth.fields.org","placeholder-key":"driver.vcd.auth.placeholders.org",type:"text",mode:a.mode,"onUpdate:value":t[1]||(t[1]=e=>{a.value.setData("org",e)})},null,8,["value","disabled","mode"])])]),(0,r.createElementVNode)("div",n,[(0,r.createElementVNode)("div",l,[(0,r.createVNode)(g,{value:a.value.decodedData.username,disabled:1!==y.step,class:"mt-20","label-key":"driver.vcd.auth.fields.username","placeholder-key":"driver.vcd.auth.placeholders.username",type:"text",mode:a.mode,"onUpdate:value":t[2]||(t[2]=e=>{a.value.setData("username",e)})},null,8,["value","disabled","mode"])]),(0,r.createElementVNode)("div",d,[(0,r.createVNode)(g,{value:a.value.decodedData.password,disabled:1!==y.step,class:"mt-20","label-key":"driver.vcd.auth.fields.password","placeholder-key":"driver.vcd.auth.placeholders.password",type:"password",mode:a.mode,"onUpdate:value":t[3]||(t[3]=e=>{a.value.setData("password",e)})},null,8,["value","disabled","mode"])])]),(0,r.createVNode)(b,{ref:"connect","label-key":"driver.vcd.auth.actions.authenticate",disabled:1!==y.step||!f.canAuthenticate,class:"mt-20",onClick:f.connect},null,8,["disabled","onClick"]),(0,r.createElementVNode)("button",{class:"btn role-primary mt-20 ml-20",disabled:y.busy||1===y.step,onClick:t[4]||(t[4]=(...e)=>f.clear&&f.clear(...e))},(0,r.toDisplayString)(e.t("driver.vcd.auth.actions.edit")),9,c),y.error?((0,r.openBlock)(),(0,r.createBlock)(w,{key:0,class:"mt-20",color:"error"},{default:(0,r.withCtx)((()=>[(0,r.createTextVNode)((0,r.toDisplayString)(y.error),1)])),_:1})):(0,r.createCommentVNode)("",!0),y.errorAllowHost?((0,r.openBlock)(),(0,r.createBlock)(w,{key:1,color:"error",class:"allow-list-error"},{default:(0,r.withCtx)((()=>[(0,r.createElementVNode)("div",null,(0,r.toDisplayString)(e.t("driver.vcd.auth.errors.notAllowed",{hostname:f.hostname})),1),(0,r.createElementVNode)("button",{disabled:y.allowBusy,class:"btn ml-10 role-primary",onClick:t[5]||(t[5]=(...e)=>f.addHostToAllowList&&f.addHostToAllowList(...e))},(0,r.toDisplayString)(e.t("driver.vcd.auth.actions.addToAllowList")),9,u)])),_:1})):(0,r.createCommentVNode)("",!0),y.vdcs?((0,r.openBlock)(),(0,r.createElementBlock)("div",p,[(0,r.createElementVNode)("div",h,[(0,r.createVNode)(k,{value:y.vdc,"onUpdate:value":[t[6]||(t[6]=e=>y.vdc=e),t[7]||(t[7]=e=>{a.value.setData("vdc",e)})],"label-key":"driver.vcd.auth.fields.vdc",options:f.vdcOptions,searchable:!1},null,8,["value","options"])]),(0,r.createElementVNode)("div",v,[(0,r.createVNode)(k,{value:y.vappName,"onUpdate:value":[t[8]||(t[8]=e=>y.vappName=e),t[9]||(t[9]=e=>{a.value.setData("vappName",e)})],"label-key":"driver.vcd.auth.fields.vapp",options:f.vappNamesOptions,searchable:!1},null,8,["value","options"])])])):(0,r.createCommentVNode)("",!0)])}var y=a(9151),f=a(7229),g=a(4248),b=a(667),w=a(4220);const k=e=>((0,r.pushScopeId)("data-v-58c7118c"),e=e(),(0,r.popScopeId)(),e),N=["disabled","tab-index","data-testid"],$={key:0,class:"icon icon-lg icon-spinner icon-spin"},A={key:1,class:"icon-spacer"},D=k((()=>(0,r.createElementVNode)("span",{class:"icon-spacer"},null,-1)));function V(e,t,a,s,o,i){return(0,r.openBlock)(),(0,r.createElementBlock)("button",{ref:"btn",class:"btn role-primary",disabled:a.disabled,"tab-index":a.tabIndex,"data-testid":a.componentTestid+"-async-button",onClick:t[0]||(t[0]=(...e)=>i.clicked&&i.clicked(...e))},[o.busy?((0,r.openBlock)(),(0,r.createElementBlock)("i",$)):((0,r.openBlock)(),(0,r.createElementBlock)("span",A)),(0,r.createElementVNode)("span",null,(0,r.toDisplayString)(i.displayLabel),1),D],8,N)}var B={props:{label:{type:String,default:void 0},labelKey:{type:String,default:void 0},disabled:{type:Boolean,default:!1},tabIndex:{type:Number,default:null},componentTestid:{type:String,default:"busy-button"},manual:{type:Boolean,default:!1}},data(){return{busy:!1}},computed:{displayLabel(){if(this.labelKey){const e=this.$store.getters["i18n/t"];return e(this.labelKey)}return this.label}},methods:{clicked(e){if(e&&(e.stopPropagation(),e.preventDefault()),this.disabled)return;const t=()=>{this.busy=!1};this["busy"]=!0,this.$emit("click",t)},focus(){this.$refs.btn.focus()}}},C=(a(3160),a(7433));const S=(0,C.A)(B,[["render",V],["__scopeId","data-v-58c7118c"]]);var _=S,E=a(9382),O=a(4364),q={components:{Banner:y.A,BusyButton:_,LabeledInput:f.o,LabeledSelect:g.A},props:{mode:{type:String,required:!0},value:{type:Object,required:!0}},async fetch(){this.driver=await this.$store.dispatch("rancher/find",{type:"nodedriver",id:"vcd"})},data(){return this.mode!==w.YQ&&(this.value.decodedData.username=this.value.annotations["vcd.cattle.io/username"],this.value.decodedData.org=this.value.annotations["vcd.cattle.io/org"],this.value.decodedData.href=this.value.annotations["vcd.cattle.io/href"]),{vdcs:null,vdc:"",vappNames:null,vappName:"",step:1,busy:!1,errorAllowHost:!1,driver:{},allowBusy:!1,error:""}},computed:{vdcOptions(){const e=(this.vdcs||[]).sort(((e,t)=>e.name.localeCompare(t.name)));return e.map((e=>({label:e.name,value:e.name})))},vappNamesOptions(){const e=(this.vappNames||[]).sort(((e,t)=>e.name.localeCompare(t.name)));return e.map((e=>({label:e.name,value:e.name})))},hostname(){const e=(0,b.qg)(this.value.decodedData.href);return e?.host||""},canAuthenticate(){return!!this.value?.decodedData?.href&&!!this.value?.decodedData?.org&&!!this.value?.decodedData?.username&&!!this.value?.decodedData?.password}},created(){this.$emit("validationChanged",!1)},methods:{test(){return this.value.annotations=this.value.annotations||{},this.value.annotations["vcd.cattle.io/username"]=this.value.decodedData.username,this.value.annotations["vcd.cattle.io/org"]=this.value.decodedData.org,this.value.annotations["vcd.cattle.io/href"]=this.value.decodedData.href,""!==this.vdc&&(this.value.annotations["vcd.cattle.io/vdc"]=this.vdc),""!==this.vappName&&(this.value.annotations["vcd.cattle.io/vappName"]=this.vappName),!0},clear(){this["step"]=1,this["vdcs"]=null,this["vappNames"]=null,this["errorAllowHost"]=!1,this.$emit("validationChanged",!1)},hostInAllowList(){if(!this.driver?.whitelistDomains)return!1;const e=(0,b.qg)(this.value.decodedData.href);return!e.host||(this.driver?.whitelistDomains||[]).includes(e.host)},async addHostToAllowList(){this["allowBusy"]=!0;const e=(0,b.qg)(this.value.decodedData.href);this.driver.whitelistDomains=this.driver.whitelistDomains||[],this.hostInAllowList()||this.driver.whitelistDomains.push(e.host);try{await this.driver.save(),this.$refs.connect.$el.click()}catch(t){O.error("Could not update driver",t),this["allowBusy"]=!1}},async connect(e){this["error"]="",this["errorAllowHost"]=!1;let t=!1;if(!this.value.decodedData.href)return e(t);const a=new E.k(this.$store,{href:this.value.decodedData.href,org:this.value.decodedData.org,username:this.value.decodedData.username,password:this.value.decodedData.password});this["allowBusy"]=!1,this["step"]=2,this["busy"]=!0;const r=await a.getToken();if(r.error)O.error(r.error),t=!1,this["step"]=1,this["vdcs"]=null,502!==r.error._status||this.hostInAllowList()?502===r.error._status?this["error"]=this.t("driver.vcd.auth.errors.badGateway"):401===r.error._status?this["error"]=this.t("driver.vcd.auth.errors.unauthorized"):this["error"]=r.error.message||this.t("driver.vcd.auth.errors.other"):this["errorAllowHost"]=!0;else{const e=await a.getVdcs();e.error?(this["error"]=e.error.message,t=!1):(this["vdcs"]=e,t=!0);const r=await a.getVApps();r.error?(this["error"]=r.error.message,t=!1):(this["vappNames"]=r,t=!0)}this["busy"]=!1,this["vdc"]=this.vdcOptions[0]?.value,this["vappName"]=this.vappNamesOptions[0]?.value,this.$emit("validationChanged",t),e(t)}}};a(7595);const x=(0,C.A)(q,[["render",m],["__scopeId","data-v-026c1912"]]);var I=x},7595:function(e,t,a){var r=a(5403);r.__esModule&&(r=r.default),"string"===typeof r&&(r=[[e.id,r,""]]),r.locals&&(e.exports=r.locals);var s=a(4825).A;s("61d0baa2",r,!0,{sourceMap:!1,shadowMode:!1})},3160:function(e,t,a){var r=a(3e3);r.__esModule&&(r=r.default),"string"===typeof r&&(r=[[e.id,r,""]]),r.locals&&(e.exports=r.locals);var s=a(4825).A;s("efc6473c",r,!0,{sourceMap:!1,shadowMode:!1})}}]);
//# sourceMappingURL=vcd-node-driver-0.5.0.umd.min.cloud-credential.js.map