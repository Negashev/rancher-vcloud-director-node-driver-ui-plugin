(("undefined"!==typeof self?self:this)["webpackJsonpvcd_node_driver_0_4_0"]=("undefined"!==typeof self?self:this)["webpackJsonpvcd_node_driver_0_4_0"]||[]).push([[1],{1055:function(e,t,s){var a=s("82e9");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var r=s("0ed3").default;r("7f3a7c02",a,!0,{sourceMap:!1,shadowMode:!1})},"72dd":function(e,t,s){var a=s("90e0");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);var r=s("0ed3").default;r("114c404c",a,!0,{sourceMap:!1,shadowMode:!1})},7713:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var a=s("4048");function r(e,t,s){return(t=i(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function i(e){var t=o(e,"string");return"symbol"==typeof t?t:t+""}function o(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}class n{constructor(e,t){r(this,"href",""),r(this,"username",""),r(this,"password",""),r(this,"org",""),r(this,"orgId",""),r(this,"version","36.0"),r(this,"vdc",""),r(this,"vappName",""),r(this,"token",""),r(this,"$dispatch",void 0),t.annotations?Object.keys(t.annotations).forEach(e=>{const s=e.split("/");if(2===s.length&&"vcd.cattle.io"===s[0]){const a=s[1];this[a]=t.annotations[e]}}):Object.keys(t).forEach(e=>{this[e]=t[e]}),this.$dispatch=e.dispatch}protocolHostname(e){const t=Object(a["a"])(e);return(null===t||void 0===t?void 0:t.host)||""}getDeepKey(e,t){return t.replace(/\[([^\[\]]*)\]/g,".$1.").split(".").filter(e=>""!==e).reduce((e,t)=>e&&e[t],e)}async getToken(){const e=`/meta/proxy/${this.protocolHostname(this.href)}/cloudapi/1.0.0/sessions`,t={Accept:"application/*;version="+this.version,"X-API-Auth-Header":"Basic "+btoa(`${this.username}@${this.org}:${this.password}`)};try{const s=await this.$dispatch("management/request",{url:e,headers:t,method:"POST",redirectUnauthorized:!1},{root:!0});if(502===s._status)return{error:"Could not proxy request - URL may not be in Rancher's allow list"};const a=s._headers["x-vmware-vcloud-access-token"];return this.token=a,this.orgId=s.org.id.replace(/^urn:vcloud:org:/,""),s}catch(s){return console.error(s),{error:s}}}async getCatalog(e,t){return await this.getOptions(e,"/query?type=catalog&pageSize=1000","record",void 0,t)}async getTemplate(e,t,s){return await this.getOptions(e,`/query?type=vAppTemplate&pageSize=1000&filter=(catalogName==${t})`,"record",void 0,s)}async getNetwork(e,t){return await this.getOptions(e,"/cloudapi/1.0.0/orgVdcNetworks?filterEncoded=true&pageSize=20&filter=((crossVdcNetworkId==null))","values",void 0,t,!0)}async getStorage(e,t){return await this.getOptions(e,"/query?type=orgVdcStorageProfile&pageSize=1000","record",e=>{if(e.vdcName===this.vdc)return e},t)}async getVAppVms(e,t,s){return await this.getOptions(e,Object(a["a"])(t).path.replace(/^\/api/,""),"children.vm",e=>{const t=e.section.find(e=>"VmSpecSectionType"===e._type);return{...e,osType:t.osType,hardwareVersionHref:t.hardwareVersion.href}},s)}async getOperatingSystem(e,t,s){return await this.getOptions(e,Object(a["a"])(t).path.replace(/^\/api/,""),"supportedOperatingSystems.operatingSystemFamilyInfo[1].operatingSystem",e=>({...e,name:e.internalName}),s)}setOptions(e,t,s,a,r){if(e){let i=this.getDeepKey(e,s)||[];if(a&&(i=i.map(e=>a(e))),t.options=this.convertToOptions(i),t.busy=!1,r){const e=t.options.find(e=>e.value.name===r);e&&(t.selected=e.value)}!t.selected&&t.options.length>0&&(t.selected=t.options[0].value)}else t.options=[],t.selected=null,t.busy=!1,t.enabled=!1}async getOptions(e,t,s,a,r,i){var o;e.busy=!0,e.enabled=!0,e.selected="";let n=!0,l=await this.makeComputeRequest(t,i);const d=l;let c=1;if(null!==(o=l)&&void 0!==o&&o.pageCount)while(n){var u,h;(null===(u=l)||void 0===u?void 0:u.pageCount)>(null===(h=l)||void 0===h?void 0:h.page)?(c=l.page+1,l=await this.makeComputeRequest(`${t}&page=${c}`,i),d[s]=d[s].concat(l[s])):n=!1}this.setOptions(d,e,s,a,r)}async makeComputeRequest(e,t){const s=t?Object(a["a"])(this.href).host:this.href.replace(/^https?:\/\//,""),r="/meta/proxy/"+s,i=`${r}${e}`,o=t?{Accept:"application/json;multisite=global;version="+this.version,"X-API-Auth-Header":"Bearer "+this.token}:{Accept:"application/*+json;version="+this.version,"X-API-Auth-Header":"Bearer "+this.token};try{const e=await this.$dispatch("management/request",{url:i,headers:o,method:"GET",redirectUnauthorized:!1},{root:!0});return e}catch(n){console.error(n)}}async getVdcs(){const e=this.href.replace(/^https?:\/\//,""),t="/meta/proxy/"+e,s={Accept:"application/*+json;version="+this.version,"X-API-Auth-Header":"Bearer "+this.token};try{const e=await this.$dispatch("management/request",{url:`${t}/org/${this.orgId}/vdcRollup`,headers:s,method:"GET",redirectUnauthorized:!1},{root:!0});return null===e||void 0===e?void 0:e.orgVdcReference}catch(a){return console.error(a),{error:a}}}async getVApps(){const e=this.href.replace(/^https?:\/\//,""),t="/meta/proxy/"+e,s={Accept:"application/*+json;version="+this.version,"X-API-Auth-Header":"Bearer "+this.token};try{const e=await this.$dispatch("management/request",{url:t+"/query?type=vApp&pageSize=1000",headers:s,method:"GET",redirectUnauthorized:!1},{root:!0});return null===e||void 0===e?void 0:e.record}catch(a){return console.error(a),{error:a}}}convertToOptions(e){let t=(e||[]).sort((e,t)=>e.name.localeCompare(t.name));return t=t.filter(e=>void 0!==e),t.map(e=>({label:e.name,value:e}))}}},"82e9":function(e,t,s){var a=s("5eaa");t=a(!1),t.push([e.i,".icon-spacer[data-v-0842832c]{width:24px}",""]),e.exports=t},"8b8b":function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e._self._c;return t("div",[t("div",{staticClass:"row"},[t("div",{staticClass:"col span-6"},[t("LabeledInput",{attrs:{value:e.value.decodedData.href,disabled:1!==e.step,"label-key":"driver.vcd.auth.fields.href","placeholder-key":"driver.vcd.auth.placeholders.href",type:"text",mode:e.mode},on:{input:function(t){return e.value.setData("href",t)}}})],1),t("div",{staticClass:"col span-6"},[t("LabeledInput",{attrs:{value:e.value.decodedData.org,disabled:1!==e.step,"label-key":"driver.vcd.auth.fields.org","placeholder-key":"driver.vcd.auth.placeholders.org",type:"text",mode:e.mode},on:{input:function(t){return e.value.setData("org",t)}}})],1)]),t("div",{staticClass:"row"},[t("div",{staticClass:"col span-6"},[t("LabeledInput",{staticClass:"mt-20",attrs:{value:e.value.decodedData.username,disabled:1!==e.step,"label-key":"driver.vcd.auth.fields.username","placeholder-key":"driver.vcd.auth.placeholders.username",type:"text",mode:e.mode},on:{input:function(t){return e.value.setData("username",t)}}})],1),t("div",{staticClass:"col span-6"},[t("LabeledInput",{staticClass:"mt-20",attrs:{value:e.value.decodedData.password,disabled:1!==e.step,"label-key":"driver.vcd.auth.fields.password","placeholder-key":"driver.vcd.auth.placeholders.password",type:"password",mode:e.mode},on:{input:function(t){return e.value.setData("password",t)}}})],1)]),t("BusyButton",{ref:"connect",staticClass:"mt-20",attrs:{"label-key":"driver.vcd.auth.actions.authenticate",disabled:1!==e.step||!e.canAuthenticate},on:{click:e.connect}}),t("button",{staticClass:"btn role-primary mt-20 ml-20",attrs:{disabled:e.busy||1===e.step},on:{click:e.clear}},[e._v(" "+e._s(e.t("driver.vcd.auth.actions.edit"))+" ")]),e.error?t("Banner",{staticClass:"mt-20",attrs:{color:"error"}},[e._v(" "+e._s(e.error)+" ")]):e._e(),e.errorAllowHost?t("Banner",{staticClass:"allow-list-error",attrs:{color:"error"}},[t("div",[e._v(" "+e._s(e.t("driver.vcd.auth.errors.notAllowed",{hostname:e.hostname}))+" ")]),t("button",{staticClass:"btn ml-10 role-primary",attrs:{disabled:e.allowBusy},on:{click:e.addHostToAllowList}},[e._v(" "+e._s(e.t("driver.vcd.auth.actions.addToAllowList"))+" ")])]):e._e(),e.vdcs?t("div",{staticClass:"row mt-20"},[t("div",{staticClass:"col span-6"},[t("LabeledSelect",{attrs:{"label-key":"driver.vcd.auth.fields.vdc",options:e.vdcOptions,searchable:!1},on:{input:function(t){return e.value.setData("vdc",t)}},model:{value:e.vdc,callback:function(t){e.vdc=t},expression:"vdc"}})],1),t("div",{staticClass:"col span-6"},[t("LabeledSelect",{attrs:{"label-key":"driver.vcd.auth.fields.vapp",options:e.vappNamesOptions,searchable:!1},on:{input:function(t){return e.value.setData("vappName",t)}},model:{value:e.vappName,callback:function(t){e.vappName=t},expression:"vappName"}})],1)]):e._e()],1)},r=[],i=s("eb32"),o=s("8e93"),n=s("466b"),l=s("4048"),d=s("da25"),c=function(){var e=this,t=e._self._c;e._self._setupProxy;return t("button",{ref:"btn",staticClass:"btn role-primary",attrs:{disabled:e.disabled,"tab-index":e.tabIndex,"data-testid":e.componentTestid+"-async-button"},on:{click:e.clicked}},[e.busy?t("i",{staticClass:"icon icon-lg icon-spinner icon-spin"}):t("span",{staticClass:"icon-spacer"}),t("span",[e._v(e._s(e.displayLabel))]),t("span",{staticClass:"icon-spacer"})])},u=[],h=s("8bbf"),p=s.n(h),v=p.a.extend({props:{label:{type:String,default:void 0},labelKey:{type:String,default:void 0},disabled:{type:Boolean,default:!1},tabIndex:{type:Number,default:null},componentTestid:{type:String,default:"busy-button"},manual:{type:Boolean,default:!1}},data(){return{busy:!1}},computed:{displayLabel(){if(this.labelKey){const e=this.$store.getters["i18n/t"];return e(this.labelKey)}return this.label}},methods:{clicked(e){if(e&&(e.stopPropagation(),e.preventDefault()),this.disabled)return;const t=()=>{this.busy=!1};this.$set(this,"busy",!0),this.$emit("click",t)},focus(){this.$refs.btn.focus()}}}),m=v,f=(s("ae95"),s("d802")),y=Object(f["a"])(m,c,u,!1,null,"0842832c",null),b=y.exports,g=s("7713"),w={components:{Banner:i["a"],BusyButton:b,LabeledInput:o["a"],LabeledSelect:n["a"]},props:{mode:{type:String,required:!0},value:{type:Object,required:!0}},async fetch(){this.driver=await this.$store.dispatch("rancher/find",{type:"nodedriver",id:"vcd"})},data(){return this.mode!==d["e"]&&(this.value.decodedData.username=this.value.annotations["vcd.cattle.io/username"],this.value.decodedData.org=this.value.annotations["vcd.cattle.io/org"],this.value.decodedData.href=this.value.annotations["vcd.cattle.io/href"]),{vdcs:null,vdc:"",vappNames:null,vappName:"",step:1,busy:!1,errorAllowHost:!1,driver:{},allowBusy:!1,error:""}},computed:{vdcOptions(){const e=(this.vdcs||[]).sort((e,t)=>e.name.localeCompare(t.name));return e.map(e=>({label:e.name,value:e.name}))},vappNamesOptions(){const e=(this.vappNames||[]).sort((e,t)=>e.name.localeCompare(t.name));return e.map(e=>({label:e.name,value:e.name}))},hostname(){const e=Object(l["a"])(this.value.decodedData.href);return(null===e||void 0===e?void 0:e.host)||""},canAuthenticate(){var e,t,s,a;return!(null===(e=this.value)||void 0===e||null===(e=e.decodedData)||void 0===e||!e.href)&&!(null===(t=this.value)||void 0===t||null===(t=t.decodedData)||void 0===t||!t.org)&&!(null===(s=this.value)||void 0===s||null===(s=s.decodedData)||void 0===s||!s.username)&&!(null===(a=this.value)||void 0===a||null===(a=a.decodedData)||void 0===a||!a.password)}},created(){this.$emit("validationChanged",!1)},methods:{test(){return this.value.annotations=this.value.annotations||{},this.value.annotations["vcd.cattle.io/username"]=this.value.decodedData.username,this.value.annotations["vcd.cattle.io/org"]=this.value.decodedData.org,this.value.annotations["vcd.cattle.io/href"]=this.value.decodedData.href,""!==this.vdc&&(this.value.annotations["vcd.cattle.io/vdc"]=this.vdc),""!==this.vappName&&(this.value.annotations["vcd.cattle.io/vappName"]=this.vappName),!0},clear(){this.$set(this,"step",1),this.$set(this,"vdcs",null),this.$set(this,"vappNames",null),this.$set(this,"errorAllowHost",!1),this.$emit("validationChanged",!1)},hostInAllowList(){var e,t;if(null===(e=this.driver)||void 0===e||!e.whitelistDomains)return!1;const s=Object(l["a"])(this.value.decodedData.href);return!s.host||((null===(t=this.driver)||void 0===t?void 0:t.whitelistDomains)||[]).includes(s.host)},async addHostToAllowList(){this.$set(this,"allowBusy",!0);const e=Object(l["a"])(this.value.decodedData.href);this.driver.whitelistDomains=this.driver.whitelistDomains||[],this.hostInAllowList()||this.driver.whitelistDomains.push(e.host);try{await this.driver.save(),this.$refs.connect.$el.click()}catch(t){console.error("Could not update driver",t),this.$set(this,"allowBusy",!1)}},async connect(e){var t,s;this.$set(this,"error",""),this.$set(this,"errorAllowHost",!1);let a=!1;if(!this.value.decodedData.href)return e(a);const r=new g["a"](this.$store,{href:this.value.decodedData.href,org:this.value.decodedData.org,username:this.value.decodedData.username,password:this.value.decodedData.password});this.$set(this,"allowBusy",!1),this.$set(this,"step",2),this.$set(this,"busy",!0);const i=await r.getToken();if(i.error)console.error(i.error),a=!1,this.$set(this,"step",1),this.$set(this,"vdcs",null),502!==i.error._status||this.hostInAllowList()?502===i.error._status?this.$set(this,"error",this.t("driver.vcd.auth.errors.badGateway")):401===i.error._status?this.$set(this,"error",this.t("driver.vcd.auth.errors.unauthorized")):this.$set(this,"error",i.error.message||this.t("driver.vcd.auth.errors.other")):this.$set(this,"errorAllowHost",!0);else{const e=await r.getVdcs();e.error?(this.$set(this,"error",e.error.message),a=!1):(this.$set(this,"vdcs",e),a=!0);const t=await r.getVApps();t.error?(this.$set(this,"error",t.error.message),a=!1):(this.$set(this,"vappNames",t),a=!0)}this.$set(this,"busy",!1),this.$set(this,"vdc",null===(t=this.vdcOptions[0])||void 0===t?void 0:t.value),this.$set(this,"vappName",null===(s=this.vappNamesOptions[0])||void 0===s?void 0:s.value),this.$emit("validationChanged",a),e(a)}}},$=w,k=(s("d8d8"),Object(f["a"])($,a,r,!1,null,"650d9e53",null));t["default"]=k.exports},"90e0":function(e,t,s){var a=s("5eaa");t=a(!1),t.push([e.i,".allow-list-error[data-v-650d9e53]{display:flex}.allow-list-error[data-v-650d9e53]>:first-child{flex:1}",""]),e.exports=t},ae95:function(e,t,s){"use strict";s("1055")},d8d8:function(e,t,s){"use strict";s("72dd")}}]);
//# sourceMappingURL=vcd-node-driver-0.4.0.umd.min.cloud-credential.js.map